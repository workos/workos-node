# ENT-3983 Phase 1: Node.js SDK Implementation Guide

## Background

### What We're Doing

This implementation adds two critical reliability features to the WorkOS Node.js SDK for audit log event creation:

1. **Automatic Idempotency Key Generation**: The SDK will automatically generate and send UUID v4 idempotency keys with every audit log event creation request, ensuring better deduplication and preventing duplicate events.

2. **Automatic Retry Logic**: The SDK will implement exponential backoff retry logic for transient failures (network errors, 5xx status codes, rate limits), improving reliability without requiring manual retry handling from users.

### Why We're Doing This

**Current Problems:**
- **No Automatic Idempotency**: Users must manually provide idempotency keys, which is error-prone and often forgotten. Without idempotency keys, duplicate events can be created if network issues cause retries or if users accidentally call the API multiple times.
- **No Automatic Retries**: Transient failures (network hiccups, temporary server errors) cause immediate failures, forcing users to implement their own retry logic. This leads to inconsistent implementations and lost events.
- **Poor Reliability**: Without these features, audit log ingestion is less reliable, potentially causing data loss or duplicate events in production.

**Benefits:**
- **Better Deduplication**: Automatic idempotency keys ensure the API can properly deduplicate events, even if network issues cause duplicate requests.
- **Improved Reliability**: Automatic retries handle transient failures transparently, reducing the chance of lost events.
- **Better Developer Experience**: Developers don't need to implement retry logic or remember to provide idempotency keys.
- **Consistent Behavior**: All SDK users get the same reliable behavior by default.

### API Support

The WorkOS API already supports idempotency keys via the `Idempotency-Key` HTTP header:
- If provided, the API hashes the key with event data for deduplication
- If not provided, the API auto-generates one (but SDKs should provide it proactively)
- Location: `packages/api/src/audit-log-events/audit-log-events.controller.ts`

---

## Current State vs Desired State

### Current State (Node.js SDK)

**Repository**: https://github.com/workos/workos-node

**Current Implementation:**
- ❌ **Idempotency Keys**: Not automatically generated. Users must manually provide `idempotencyKey` parameter.
- ❌ **Retry Logic**: No automatic retry mechanism. Requests fail immediately on errors.
- ⚠️ **Error Handling**: Basic error handling exists but lacks retry-specific error types.

**Code Locations:**
- Audit Logs Module: `src/audit-logs/` directory
- HTTP Client: `src/client.ts` or `src/httpClient.ts`
- Main WorkOS Class: `src/workos.ts`

### Desired State

**After Implementation:**
- ✅ **Idempotency Keys**: Automatically generated UUID v4 for every audit log event creation request
- ✅ **Retry Logic**: Exponential backoff retry for network errors, 5xx status codes, and 429 (rate limit)
- ✅ **Error Handling**: Proper error types distinguishing retryable vs non-retryable errors
- ✅ **Backward Compatibility**: Existing code that manually provides idempotency keys continues to work

---

## Implementation Checklist

### Phase 1: Setup and Code Exploration

- [ ] **Clone and explore the repository**
  - Clone `https://github.com/workos/workos-node`
  - Review the current audit logs implementation in `src/audit-logs/`
  - Review the HTTP client implementation in `src/client.ts` or `src/httpClient.ts`
  - Understand how requests are currently made and how headers are set

- [ ] **Review existing test structure**
  - Locate test files for audit logs (likely `src/audit-logs/*.test.ts` or `src/audit-logs/*.spec.ts`)
  - Understand the testing patterns used in the SDK
  - Review how HTTP requests are mocked in tests

- [ ] **Check dependencies**
  - Verify if `uuid` package is available (Node.js has built-in `crypto.randomUUID()` in Node 14.17.0+)
  - Check if any retry libraries are already in use
  - Review `package.json` for existing dependencies

### Phase 2: Implement Idempotency Key Generation

- [ ] **Add UUID generation utility**
  - Create or update utility function to generate UUID v4
  - Use Node.js built-in `crypto.randomUUID()` (Node 14.17.0+) or `uuid` package
  - Location: Consider `src/utils/uuid.ts` or similar

- [ ] **Modify audit log event creation method**
  - Locate the method that creates audit log events (likely in `src/audit-logs/index.ts`)
  - Add logic to auto-generate UUID v4 idempotency key if not provided by user
  - Ensure backward compatibility: if user provides `idempotencyKey`, use it instead
  - Set the `Idempotency-Key` HTTP header in the request

- [ ] **Update method signature (if needed)**
  - Ensure `idempotencyKey` parameter is optional (should already be)
  - Document that idempotency keys are now auto-generated by default

- [ ] **Update HTTP client (if needed)**
  - Ensure the HTTP client can accept and send the `Idempotency-Key` header
  - Verify header is sent correctly in the request

### Phase 3: Implement Auto-Retry Logic

- [ ] **Create retry utility function**
  - Create a retry function with exponential backoff
  - Location: Consider `src/utils/retry.ts` or similar
  - Parameters:
    - `fn`: Function to retry (async)
    - `maxRetries`: Maximum number of retry attempts (default: 3-5)
    - `baseDelay`: Base delay in milliseconds (default: 1000ms)
    - `maxDelay`: Maximum delay in milliseconds (default: 30000ms)
    - `jitter`: Random jitter percentage (default: 0-25%)

- [ ] **Implement exponential backoff with jitter**
  - Formula: `delay = min(baseDelay * 2^attempt + random(0, jitter * delay), maxDelay)`
  - Add random jitter to prevent thundering herd problem
  - Ensure delays are reasonable (not too short, not too long)

- [ ] **Implement retry condition logic**
  - **Retry on:**
    - Network errors (connection failures, timeouts, ECONNRESET, etc.)
    - 5xx HTTP status codes (500, 502, 503, 504, etc.)
    - 429 (Too Many Requests) - rate limit errors
  - **Do NOT retry on:**
    - 4xx client errors (except 429)
    - 400 (Bad Request) - validation errors
    - 401 (Unauthorized) - authentication errors
    - 403 (Forbidden) - authorization errors
    - 404 (Not Found) - resource not found

- [ ] **Handle Retry-After header**
  - For 429 responses, check for `Retry-After` header
  - If present, use that value instead of exponential backoff
  - Respect the `Retry-After` value (may be in seconds or as a date)

- [ ] **Integrate retry logic into audit log event creation**
  - Wrap the HTTP request in the retry function
  - Ensure retry logic only applies to audit log event creation (not other endpoints)
  - Make retry configuration optional/configurable

- [ ] **Add retry attempt tracking**
  - Track number of retry attempts
  - Include attempt information in error messages (if applicable)
  - Consider logging retry attempts for debugging (optional)

### Phase 4: Error Handling

- [ ] **Review existing error types**
  - Understand current error handling in the SDK
  - Identify error classes/types used

- [ ] **Create or update retry-specific error types**
  - Create error type for "max retries exceeded" scenarios
  - Ensure errors distinguish between retryable and non-retryable failures
  - Include relevant context (status code, response body, retry attempts)

- [ ] **Update error messages**
  - Provide clear error messages indicating why a request failed
  - Include retry attempt information if applicable
  - Distinguish between retryable and non-retryable errors

- [ ] **Ensure proper error propagation**
  - Errors should be properly thrown/caught
  - Non-retryable errors should fail immediately
  - Retryable errors should trigger retries until max attempts

### Phase 5: Testing

- [ ] **Unit tests for idempotency key generation**
  - Test that UUID v4 is generated when not provided
  - Test that provided idempotency key is used (backward compatibility)
  - Test that `Idempotency-Key` header is set correctly
  - Location: `src/audit-logs/*.test.ts` or similar

- [ ] **Unit tests for retry logic**
  - Test retry on 5xx status codes
  - Test retry on network errors
  - Test retry on 429 with and without `Retry-After` header
  - Test no retry on 4xx errors (except 429)
  - Test exponential backoff calculation
  - Test jitter is applied correctly
  - Test max retry limit is respected
  - Location: `src/utils/retry.test.ts` or similar

- [ ] **Integration tests**
  - Test idempotency key deduplication (same key = same response)
  - Test actual retry behavior with mock server
  - Test that retries don't cause duplicate events (due to idempotency)
  - Verify error handling works correctly

- [ ] **Edge case tests**
  - Test with various network error types
  - Test with different HTTP status codes
  - Test with `Retry-After` header in different formats
  - Test with very long retry delays
  - Test concurrent requests

### Phase 6: Documentation and Examples

- [ ] **Update method documentation**
  - Document that idempotency keys are now auto-generated
  - Document that `idempotencyKey` parameter is optional
  - Document retry behavior and configuration options
  - Add JSDoc comments to methods

- [ ] **Update README or main documentation**
  - Add section about automatic idempotency keys
  - Add section about automatic retries
  - Document retry configuration options (if configurable)
  - Update examples if needed

- [ ] **Update code examples**
  - Ensure examples reflect new automatic behavior
  - Show how to override idempotency key if needed
  - Show how to configure retry behavior (if configurable)

### Phase 7: Code Review and Polish

- [ ] **Code quality checks**
  - Run linter: `npm run lint` or similar
  - Fix any linting errors
  - Ensure code follows SDK's style guide

- [ ] **Type safety**
  - Ensure TypeScript types are correct
  - Add proper type definitions for new functions/options
  - Ensure no `any` types are used

- [ ] **Backward compatibility verification**
  - Test that existing code still works
  - Verify that manually provided idempotency keys are respected
  - Ensure no breaking changes

- [ ] **Performance considerations**
  - Ensure retry logic doesn't add significant overhead
  - Verify UUID generation is efficient
  - Check that delays are reasonable

### Phase 8: Final Validation

- [ ] **Manual testing**
  - Test with actual WorkOS API (if possible in dev environment)
  - Verify idempotency key is sent in requests
  - Verify retries work on actual 5xx errors
  - Test with network failures (disable network temporarily)

- [ ] **Review checklist completion**
  - Ensure all checklist items are completed
  - Verify no steps were skipped
  - Double-check error handling and edge cases

- [ ] **Prepare for PR**
  - Write clear PR description
  - Link to this implementation guide
  - Include test results
  - Note any breaking changes (should be none)

---

## Implementation Details

### Idempotency Key Generation

**Format**: UUID v4 (e.g., `550e8400-e29b-41d4-a716-446655440000`)

**Implementation:**
```typescript
// Use Node.js built-in (Node 14.17.0+)
import { randomUUID } from 'crypto';

// Or use uuid package if needed for older Node versions
// import { v4 as uuidv4 } from 'uuid';

const idempotencyKey = userProvidedKey || randomUUID();
```

**Header**: Send as `Idempotency-Key` HTTP header

**Backward Compatibility**: If user provides `idempotencyKey` parameter, use it instead of generating one.

### Retry Logic

**Retry Strategy**: Exponential backoff with jitter

**Configuration:**
- Base delay: 1000ms (1 second)
- Max delay: 30000ms (30 seconds)
- Max retries: 3-5 attempts (configurable)
- Jitter: Random 0-25% of calculated delay

**Formula:**
```
delay = min(baseDelay * 2^attempt + random(0, jitter * delay), maxDelay)
```

**Retry Conditions:**
- ✅ Network errors (ECONNRESET, ETIMEDOUT, ENOTFOUND, etc.)
- ✅ 5xx HTTP status codes
- ✅ 429 (Too Many Requests)
- ❌ 4xx errors (except 429)
- ❌ Validation errors
- ❌ Authentication/authorization errors

**Retry-After Header:**
- For 429 responses, check for `Retry-After` header
- If present, use that value (may be seconds or HTTP date)
- Override exponential backoff with `Retry-After` value

### Error Handling

**Error Types:**
- Distinguish between retryable and non-retryable errors
- Provide clear error messages
- Include retry attempt information when applicable

**Error Messages:**
- Non-retryable errors: Fail immediately with clear message
- Retryable errors: Retry up to max attempts, then throw error with context
- Include status code, response body, and retry attempts in final error

---

## Testing Requirements

### Must Test

- ✅ Idempotency key is automatically generated and sent
- ✅ Same idempotency key returns same response (deduplication)
- ✅ Retries occur on 5xx errors
- ✅ Retries occur on network errors
- ✅ Retries respect `Retry-After` header for 429
- ✅ No retries on 4xx errors (except 429)
- ✅ Exponential backoff with jitter works correctly
- ✅ Max retry limit is respected
- ✅ Error messages are appropriate
- ✅ Backward compatibility: manually provided idempotency keys work

### Test Scenarios

1. **Idempotency Key Tests:**
   - Auto-generation when not provided
   - User-provided key is used
   - Header is set correctly
   - Same key = same response (deduplication)

2. **Retry Logic Tests:**
   - Retry on 500, 502, 503, 504
   - Retry on network errors
   - Retry on 429 with `Retry-After`
   - No retry on 400, 401, 403, 404
   - Exponential backoff calculation
   - Jitter application
   - Max retry limit

3. **Error Handling Tests:**
   - Proper error types thrown
   - Error messages are clear
   - Retry attempt information included
   - Non-retryable errors fail immediately

---

## Code Locations to Modify

### Primary Files

1. **Audit Logs Module**
   - `src/audit-logs/index.ts` - Main audit log event creation method
   - `src/audit-logs/*.test.ts` - Tests for audit logs

2. **HTTP Client**
   - `src/client.ts` or `src/httpClient.ts` - HTTP request handling
   - May need to add header support if not already present

3. **Utilities (New or Existing)**
   - `src/utils/uuid.ts` - UUID generation utility (if needed)
   - `src/utils/retry.ts` - Retry logic utility (new file)

4. **Error Handling**
   - `src/errors.ts` or similar - Error types/classes
   - May need to add retry-specific error types

### Secondary Files

- `package.json` - Dependencies (if uuid package needed)
- `README.md` - Documentation updates
- `src/workos.ts` - Main WorkOS class (if configuration needed)

---

## Backward Compatibility

### Critical Requirements

1. **Idempotency Keys**
   - Existing code that provides `idempotencyKey` parameter must continue to work
   - SDK should use provided key instead of generating one
   - No breaking changes to method signatures

2. **Retry Logic**
   - Retry logic should be transparent to users
   - Should not change behavior for successful requests
   - Should not cause duplicate events (thanks to idempotency keys)

3. **Error Handling**
   - Existing error types should remain the same
   - New error types should extend existing ones if possible
   - Error messages should be clear but not break existing error handling

---

## Notes and Considerations

- **Node.js Version**: Ensure compatibility with supported Node.js versions. Use `crypto.randomUUID()` for Node 14.17.0+, or `uuid` package for older versions.

- **Retry Configuration**: Consider making retry configuration optional (max retries, delays) but provide sensible defaults.

- **Logging**: Consider adding optional logging for retry attempts (debug level) to help with troubleshooting.

- **Performance**: Retry logic should not significantly impact performance for successful requests. Only add overhead when retries are needed.

- **Testing**: Use a mocking library (like `nock` or similar) to test retry behavior without hitting actual API.

- **Documentation**: Update all relevant documentation to reflect automatic idempotency keys and retry behavior.

---

## Success Criteria

Implementation is complete when:

1. ✅ Idempotency keys are automatically generated for all audit log event creation requests
2. ✅ Retry logic handles transient failures with exponential backoff
3. ✅ All tests pass (unit and integration)
4. ✅ Backward compatibility is maintained
5. ✅ Documentation is updated
6. ✅ Code review is approved
7. ✅ No breaking changes introduced

---

## References

- **Repository**: https://github.com/workos/workos-node
- **API Implementation**: `packages/api/src/audit-log-events/audit-log-events.controller.ts` (in main monorepo)
- **Parent Ticket**: ENT-3983
- **Phase 1 Audit**: ENT-3983-phase1.md

---

## Questions or Issues?

If you encounter any issues or have questions during implementation:

1. Review the API implementation in the main monorepo for reference
2. Check existing SDK patterns for consistency
3. Consult with the team if behavior is unclear
4. Update this document with any findings or clarifications


